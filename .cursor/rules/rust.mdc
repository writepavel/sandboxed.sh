---
description: Rust backend conventions for Open Agent
globs: ["*.rs"]
---

# Rust Conventions

## Code Style

1. **Never panic** - always return `Result<T, E>`
2. **Exhaustive matches** - no `_` catch-all patterns in enums
3. **Document invariants** as `/// Precondition:` and `/// Postcondition:` comments
4. **Pure functions** - separate pure logic from IO where possible
5. **Algebraic types** - prefer enums with exhaustive matching

## Error Handling

```rust
// Use thiserror for error types
#[derive(Debug, Error)]
pub enum MyError {
    #[error("description: {0}")]
    Variant(String),
}

// Propagate with ?
pub fn do_thing() -> Result<T, MyError> {
    let x = fallible_op()?;
    Ok(x)
}
```

## Adding a New Tool

1. Add to `src/tools/` (new file or extend existing)
2. Implement `Tool` trait: `name()`, `description()`, `parameters()`, `call()`
3. Register in `src/tools/mod.rs` â†’ `create_tools()`
4. Tool parameters use serde_json schema format

## Budget/Cost Types

```rust
// All costs are in cents (u64) - never use floats for money
Budget::new(initial_cents: u64)
budget.spend(amount_cents: u64) -> Result<(), BudgetError>
budget.allocate(amount_cents: u64) -> Result<(), BudgetError>
```

## Key Crates

| Crate | Purpose |
|-------|---------|
| `axum` | HTTP server + WebSocket |
| `tokio` | Async runtime |
| `reqwest` | HTTP client |
| `serde`/`serde_json` | Serialization |
| `jsonwebtoken` | JWT auth |
| `portable-pty` | PTY for SSH console |

## Running Locally

```bash
# Dev build with debug logging
RUST_LOG=debug cargo run

# Release build
cargo build --release

# Run calibration
cargo run --release --bin calibrate -- --workspace ./.open_agent_calibration --model openai/gpt-4.1-mini --write-tuning
```
