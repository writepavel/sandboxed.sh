# Example: Debounced CI workflow
# This workflow waits 6 hours after the last commit before running CI
# To enable: rename this file to ci-debounced.yml and disable/remove ci.yml

name: CI Debounced

on:
  # This workflow is triggered by workflow_dispatch for manual runs
  # or on a schedule to check for stale PRs
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *' # Every 6 hours

# Prevent concurrent runs
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  check-stale-prs:
    name: Find PRs with no commits in 6+ hours
    runs-on: ubuntu-latest
    outputs:
      pr_numbers: ${{ steps.find-prs.outputs.pr_numbers }}
    steps:
      - name: Find stale PRs
        id: find-prs
        uses: actions/github-script@v7
        with:
          script: |
            const sixHoursAgo = new Date(Date.now() - 6 * 60 * 60 * 1000);

            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            const stalePRs = [];

            for (const pr of pulls) {
              if (pr.draft) continue; // Skip draft PRs

              const { data: commits } = await github.rest.pulls.listCommits({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                per_page: 1
              });

              if (commits.length > 0) {
                const lastCommitDate = new Date(commits[commits.length - 1].commit.committer.date);
                if (lastCommitDate < sixHoursAgo) {
                  stalePRs.push(pr.number);
                  console.log(`PR #${pr.number} is stale (last commit: ${lastCommitDate})`);
                }
              }
            }

            core.setOutput('pr_numbers', JSON.stringify(stalePRs));
            return stalePRs;

  test:
    name: Test
    needs: check-stale-prs
    if: needs.check-stale-prs.outputs.pr_numbers != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        pr_number: ${{ fromJson(needs.check-stale-prs.outputs.pr_numbers) }}
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ matrix.pr_number }}/head

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Run tests
        run: cargo test --workspace

      - name: Comment on PR
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ matrix.pr_number }},
              body: 'âŒ CI tests failed on scheduled run. Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}).'
            });
