<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JS Bridge Integration Tests - Origin Validation</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    #status { background: #f0f0f0; padding: 20px; border-radius: 8px; margin-top: 20px; }
    .pass { color: green; }
    .fail { color: red; }
  </style>
</head>
<body>
  <h1>üß™ JS Bridge Integration Tests</h1>
  <p><strong>Origin:</strong> <span id="origin"></span></p>
  <p>Running automated tests for DApp-browser JS bridge communication flows with origin validation.</p>
  <div id="status">Loading bridge and running tests...</div>

  <script src="mock-bridge.js"></script>
  <script>
    window.testResults = [];
    window.testSummary = { total: 0, passed: 0, failed: 0 };

    document.getElementById('origin').textContent = window.location.origin;

    async function runIntegrationTests() {
      const status = document.getElementById('status');
      status.innerHTML = '<p>üöÄ Running tests...</p>';

      const tests = [
        {
          name: 'isConnected',
          fn: async () => {
            const result = window.bridge.isConnected();
            return { expected: window.location.origin === 'http://localhost:3000', actual: result };
          }
        },
        {
          name: 'connect',
          fn: async () => {
            const result = await window.bridge.connect();
            return { expected: true, actual: result };
          }
        },
        {
          name: 'signMessage',
          fn: async () => {
            const result = await window.bridge.signMessage('Hello, world!');
            return { expected: result.startsWith('0xsignature'), actual: result };
          }
        },
        {
          name: 'sendTransaction',
          fn: async () => {
            const result = await window.bridge.sendTransaction({ to: '0x1234567890123456789012345678901234567890', value: '0x1' });
            return { expected: result.startsWith('0x123456789abcdef'), actual: result };
          }
        }
      ];

      for (const test of tests) {
        try {
          const { expected, actual } = await test.fn();
          const pass = (window.location.origin === 'http://localhost:3000' ? expected : !expected);
          window.testResults.push({ test: test.name, pass, expected, actual, origin: window.location.origin });
          window.testSummary.total++;
          if (pass) window.testSummary.passed++;
          status.innerHTML += `<p class="${pass ? 'pass' : 'fail'}">‚úÖ/‚ùå ${test.name}: ${pass ? 'PASS' : 'FAIL'} (expected: ${JSON.stringify(expected)}, got: ${JSON.stringify(actual)})</p>`;
        } catch (error) {
          window.testResults.push({ test: test.name, pass: false, error: error.message, origin: window.location.origin });
          window.testSummary.total++;
          window.testSummary.failed++;
          status.innerHTML += `<p class="fail">‚ùå ${test.name}: FAIL - ${error.message}</p>`;
        }
      }

      const allPass = window.testSummary.passed === window.testSummary.total;
      status.innerHTML += `<p><strong>Summary: ${window.testSummary.passed}/${window.testSummary.total} passed</strong> ${allPass ? 'üéâ All good!' : '‚ö†Ô∏è Some failures'}</p>`;
      status.innerHTML += `<p><a href="#" onclick="return JSON.stringify(window.testResults, null, 2)">View Raw Results</a></p>`;
    }

    // Run tests after DOM and bridge loaded
    if (window.bridge) {
      runIntegrationTests();
    } else {
      setTimeout(runIntegrationTests, 500);
    }
  </script>
</body>
</html>